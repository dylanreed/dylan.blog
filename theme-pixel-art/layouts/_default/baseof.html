<!doctype html>
<html lang="en">
<head>
    {{- partial "head.html" . -}}
</head>
<body>
    <script>
        // Apply saved theme immediately to prevent flash
        if (localStorage.getItem('theme') === 'night') {
            document.body.classList.add('night');
        }
    </script>

    <!-- Sierra-style Control Panel -->
    <div class="sierra-trigger"></div>
    <div class="sierra-panel">
        <div class="sierra-panel-bg">
            <div class="sierra-title"><span>Controls</span></div>
            <div class="sierra-buttons">
                <button class="sierra-btn" data-action="theme" data-tooltip="Day/Night">
                    <img class="btn-icon moon" src="/sprites/moon.png" alt="Night mode">
                    <img class="btn-icon sun" src="/sprites/sun.png" alt="Day mode" style="display:none">
                </button>
                <button class="sierra-btn" data-action="chaos" data-tooltip="Chaos Mode">
                    <span class="btn-icon">üåÄ</span>
                </button>
                <button class="sierra-btn" data-action="achievements" data-tooltip="Achievements">
                    <span class="btn-icon">üèÜ</span>
                </button>
                <button class="sierra-btn" data-action="rainbow" data-tooltip="Rainbow">
                    <span class="btn-icon">üåà</span>
                </button>
                <button class="sierra-btn" data-action="weather" data-tooltip="Weather">
                    <span class="btn-icon">üåßÔ∏è</span>
                </button>
                <button class="sierra-btn" data-action="help" data-tooltip="Help">
                    <span class="btn-icon">‚ùì</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Sierra Panel Button Handler
        (function() {
            const panel = document.querySelector('.sierra-panel');
            if (!panel) return;

            // Theme toggle
            function updateThemeButton() {
                const moonIcon = panel.querySelector('[data-action="theme"] .moon');
                const sunIcon = panel.querySelector('[data-action="theme"] .sun');
                const isNight = document.body.classList.contains('night');
                if (moonIcon) moonIcon.style.display = isNight ? 'none' : 'block';
                if (sunIcon) sunIcon.style.display = isNight ? 'block' : 'none';
            }
            updateThemeButton();

            // Weather state
            let currentWeather = null;

            panel.addEventListener('click', (e) => {
                const btn = e.target.closest('.sierra-btn');
                if (!btn) return;

                const action = btn.dataset.action;

                switch(action) {
                    case 'theme':
                        const isNight = document.body.classList.toggle('night');
                        localStorage.setItem('theme', isNight ? 'night' : 'day');
                        updateThemeButton();
                        break;

                    case 'chaos':
                        if (window.chaos) {
                            if (document.body.classList.contains('chaos-mode')) {
                                window.chaos.disable();
                            } else {
                                window.chaos.enable();
                            }
                            btn.classList.toggle('active', document.body.classList.contains('chaos-mode'));
                        }
                        break;

                    case 'achievements':
                        const achPanel = document.getElementById('achievements-panel');
                        if (achPanel) {
                            achPanel.classList.toggle('visible');
                            btn.classList.toggle('active', achPanel.classList.contains('visible'));
                        }
                        break;

                    case 'rainbow':
                        if (window.chaos) {
                            window.chaos.rainbow();
                            btn.classList.toggle('active', document.body.classList.contains('rainbow-mode'));
                        }
                        break;

                    case 'weather':
                        if (window.chaosWeather) {
                            if (currentWeather === null) {
                                window.chaosWeather.rain();
                                currentWeather = 'rain';
                                btn.innerHTML = '<span class="btn-icon">üåßÔ∏è</span>';
                            } else if (currentWeather === 'rain') {
                                window.chaosWeather.snow();
                                currentWeather = 'snow';
                                btn.innerHTML = '<span class="btn-icon">‚ùÑÔ∏è</span>';
                            } else {
                                window.chaosWeather.stop();
                                currentWeather = null;
                                btn.innerHTML = '<span class="btn-icon">‚òÄÔ∏è</span>';
                            }
                            btn.classList.toggle('active', currentWeather !== null);
                        }
                        break;

                    case 'help':
                        if (window.chaos) {
                            window.chaos.help();
                            alert('Check the browser console (F12) for chaos commands!');
                        }
                        break;
                }
            });
        })();
    </script>

    {{- partial "header.html" . -}}

    <main class="main-content">
        {{- block "main" . }}{{- end }}
    </main>

    {{- partial "footer.html" . -}}

    {{ partial "custom_footer.html" . }}
    {{ partial "plugin_js.html" . }}

    <!-- Chaos Goblin Mode -->
    <script src="/js/chaos.js?v={{ now.Unix }}"></script>
    <script src="/js/achievements.js?v={{ now.Unix }}"></script>
</body>
</html>
