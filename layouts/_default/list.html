{{ define "main" }}
{{/* Track state for grouping blogs vs notes */}}
{{ $.Scratch.Set "inBlogGroup" false }}

{{ range where .Site.RegularPages "Type" "post" }}
    {{/* Note = no title OR explicitly marked as note */}}
    {{ $isNote := or (not .Title) (eq .Params.format "note") }}

    {{ if $isNote }}
        {{/* Close blog container if we were in one */}}
        {{ if $.Scratch.Get "inBlogGroup" }}
            </div></div>
            {{ $.Scratch.Set "inBlogGroup" false }}
        {{ end }}

        {{/* Render note as scroll */}}
        <article class="note-scroll">
            <div class="note-content">
                {{ .Content }}
            </div>
            <div class="note-meta">
                <a href="{{ .Permalink }}" class="note-date">{{ .Date.Format "January 2, 2006" }}</a>
            </div>
        </article>
    {{ else }}
        {{/* Open blog container if not already in one */}}
        {{ if not ($.Scratch.Get "inBlogGroup") }}
            <div class="posts-container"><div class="posts">
            {{ $.Scratch.Set "inBlogGroup" true }}
        {{ end }}

        {{/* Render blog post */}}
        <article class="post {{ partial "category-class.html" . }}">
            {{/* Sprite based on first category */}}
            {{ partial "post-sprite.html" . }}

            <div class="post-body">
                {{/* Category tag */}}
                {{ with .Params.categories }}
                    {{ range first 1 . }}
                    <span class="post-tag">{{ . }}</span>
                    {{ end }}
                {{ end }}

                {{/* Post title - only show if exists */}}
                {{ if .Title }}
                <h2 class="post-title">
                    <a href="{{ .Permalink }}">{{ .Title }}</a>
                </h2>
                {{ end }}

                {{/* Post date */}}
                <div class="post-meta">{{ .Date.Format "January 2, 2006" }}</div>

                {{/* Excerpt or full content for short posts */}}
                <div class="post-excerpt">
                    {{ if .Summary }}
                        {{ .Summary | plainify | truncate 200 }}
                    {{ else }}
                        {{ .Content | plainify | truncate 200 }}
                    {{ end }}
                </div>

                <a href="{{ .Permalink }}" class="post-link">Read more &rarr;</a>
            </div>
        </article>
    {{ end }}
{{ end }}

{{/* Close blog container if still open */}}
{{ if $.Scratch.Get "inBlogGroup" }}
    </div></div>
{{ end }}

{{/* Pagination */}}
{{ if .Paginator }}
<nav class="pagination">
    {{ if .Paginator.HasPrev }}
    <a href="{{ .Paginator.Prev.URL }}">&larr; Newer</a>
    {{ end }}
    {{ if .Paginator.HasNext }}
    <a href="{{ .Paginator.Next.URL }}">Older &rarr;</a>
    {{ end }}
</nav>
{{ end }}
{{ end }}
